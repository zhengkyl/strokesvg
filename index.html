<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/dist/hiragana/あ.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StrokeSVG Preview</title>
    <link rel="stylesheet" href="index.css" />
    <script
      type="text/javascript"
      src="https://unpkg.com/external-svg-loader@latest/svg-loader.min.js"
      async
    ></script>
  </head>
  <body class="max-w-screen-md mx-auto my-4 px-4">
    <main un-cloak class="flex flex-col gap-4 dark:bg-stone-950">
      <h1 class="font-bold text-3xl">StrokeSVG Preview</h1>
      <div class="relative">
        <input
          id="searchInput"
          type="text"
          class="h-10 w-full rounded-md border border-stone-300 py-2 px-3 ring-offset-white placeholder:text-stone-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stone-950 focus-visible:ring-offset-2 dark:border-stone-800 dark:border-stone-800 dark:ring-offset-stone-950 dark:placeholder:text-stone-400 dark:focus-visible:ring-stone-300"
          placeholder="Search for character..."
        />
        <ul
          id="searchList"
          class="border border-stone-300 rounded-md flex-col overflow-y-auto max-h-96 w-full z-50 drop-shadow-lg absolute hidden bg-white dark:bg-stone-950"
          role="listbox"
          onmousedown="event.preventDefault()"
        ></ul>
      </div>
      <div class="flex flex-wrap gap-4">
        <svg
          id="previewSvg"
          class="border border-stone-300 rounded-md min-w-[250px] min-h-[250px] aspect-square flex-1"
          data-cache="disabled"
        ></svg>
        <div class="py-2 flex-1">
          <h2 id="previewText" class="text-2xl mb-2 text-center">
            No character selected
          </h2>
          <input
            id="progressSlider"
            type="range"
            min="0"
            max="1"
            step="0.01"
            value="1"
            autocomplete="off"
            class="cursor-pointer w-full"
            disabled
          />
          <div id="controls" class="flex gap-2 justify-center">
            <button
              disabled
              class="px-4 py-4 border border-stone-300 rounded-md inline-flex justify-center items-center hover:bg-stone-100 hover:text-stone-900 dark:border-stone-800 dark:hover:bg-stone-800 dark:hover:text-stone-50 ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stone-950 focus-visible:ring-offset-2 dark:ring-offset-stone-950 dark:focus-visible:ring-stone-300"
            >
              <div class="i-fluent:rewind-16-regular text-4xl"></div>
            </button>
            <button
              disabled
              class="px-4 py-4 bg-stone-900 text-stone-50 hover:bg-stone-900/90 dark:bg-stone-50 dark:text-stone-900 dark:hover:bg-stone-50/90 rounded-md ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stone-950 focus-visible:ring-offset-2 dark:ring-offset-stone-950 dark:focus-visible:ring-stone-300"
            >
              <div class="i-fluent:video-play-pause-20-filled text-4xl"></div>
            </button>
            <button
              disabled
              class="px-4 py-4 border border-stone-300 rounded-md inline-flex justify-center items-center hover:bg-stone-100 hover:text-stone-900 dark:border-stone-800 dark:hover:bg-stone-800 dark:hover:text-stone-50 ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stone-950 focus-visible:ring-offset-2 dark:ring-offset-stone-950 dark:focus-visible:ring-stone-300"
            >
              <div class="i-fluent:fast-forward-16-regular text-4xl"></div>
            </button>
          </div>
        </div>
      </div>
      <h3 class="font-bold text-2xl">Hiragana</h3>
      <div
        id="hiraganaBank"
        class="text-lg flex flex-wrap gap-x-2 gap-y-4 font-['Klee_One'] font-600"
      ></div>
      <h3 class="font-bold text-2xl">Katakana</h3>
      <div
        id="katakanaBank"
        class="text-lg flex flex-wrap gap-x-2 gap-y-4 font-['Klee_One'] font-600"
      ></div>
    </main>
    <script type="module">
      import { strokeAnimator } from "./index.js";

      const kana = [
        [
          { hira: "あ", kata: "ア", romaji: ["a"] },
          { hira: "い", kata: "イ", romaji: ["i"] },
          { hira: "う", kata: "ウ", romaji: ["u"] },
          { hira: "え", kata: "エ", romaji: ["e"] },
          { hira: "お", kata: "オ", romaji: ["o"] },
        ],
        [
          { hira: "か", kata: "カ", romaji: ["ka"] },
          { hira: "き", kata: "キ", romaji: ["ki"] },
          { hira: "く", kata: "ク", romaji: ["ku"] },
          { hira: "け", kata: "ケ", romaji: ["ke"] },
          { hira: "こ", kata: "コ", romaji: ["ko"] },
        ],
        [
          { hira: "が", kata: "ガ", romaji: ["ga"] },
          { hira: "ぎ", kata: "ギ", romaji: ["gi"] },
          { hira: "ぐ", kata: "グ", romaji: ["gu"] },
          { hira: "げ", kata: "ゲ", romaji: ["ge"] },
          { hira: "ご", kata: "ゴ", romaji: ["go"] },
        ],
        [
          { hira: "さ", kata: "サ", romaji: ["sa"] },
          { hira: "し", kata: "シ", romaji: ["shi", "si"] },
          { hira: "す", kata: "ス", romaji: ["su"] },
          { hira: "せ", kata: "セ", romaji: ["se"] },
          { hira: "そ", kata: "ソ", romaji: ["so"] },
        ],
        [
          { hira: "ざ", kata: "ザ", romaji: ["za"] },
          { hira: "じ", kata: "ジ", romaji: ["ji", "zi"] },
          { hira: "ず", kata: "ズ", romaji: ["zu"] },
          { hira: "ぜ", kata: "ゼ", romaji: ["ze"] },
          { hira: "ぞ", kata: "ゾ", romaji: ["zo"] },
        ],
        [
          { hira: "た", kata: "タ", romaji: ["ta"] },
          { hira: "ち", kata: "チ", romaji: ["chi", "ti"] },
          { hira: "つ", kata: "ツ", romaji: ["tsu", "tu"] },
          { hira: "て", kata: "テ", romaji: ["te"] },
          { hira: "と", kata: "ト", romaji: ["to"] },
        ],
        [
          { hira: "だ", kata: "ダ", romaji: ["da"] },
          { hira: "ぢ", kata: "ヂ", romaji: ["ji", "di", "zi"] },
          { hira: "づ", kata: "ヅ", romaji: ["zu", "du", "zu"] },
          { hira: "で", kata: "デ", romaji: ["de"] },
          { hira: "ど", kata: "ド", romaji: ["do"] },
        ],
        [
          { hira: "な", kata: "ナ", romaji: ["na"] },
          { hira: "に", kata: "ニ", romaji: ["ni"] },
          { hira: "ぬ", kata: "ヌ", romaji: ["nu"] },
          { hira: "ね", kata: "ネ", romaji: ["ne"] },
          { hira: "の", kata: "ノ", romaji: ["no"] },
        ],
        [
          { hira: "は", kata: "ハ", romaji: ["ha"] },
          { hira: "ひ", kata: "ヒ", romaji: ["hi"] },
          { hira: "ふ", kata: "フ", romaji: ["fu", "hu"] },
          { hira: "へ", kata: "ヘ", romaji: ["he"] },
          { hira: "ほ", kata: "ホ", romaji: ["ho"] },
        ],
        [
          { hira: "ば", kata: "バ", romaji: ["ba"] },
          { hira: "び", kata: "ビ", romaji: ["bi"] },
          { hira: "ぶ", kata: "ブ", romaji: ["bu"] },
          { hira: "べ", kata: "ベ", romaji: ["be"] },
          { hira: "ぼ", kata: "ボ", romaji: ["bo"] },
        ],
        [
          { hira: "ぱ", kata: "パ", romaji: ["pa"] },
          { hira: "ぴ", kata: "ピ", romaji: ["pi"] },
          { hira: "ぷ", kata: "プ", romaji: ["pu"] },
          { hira: "ぺ", kata: "ペ", romaji: ["pe"] },
          { hira: "ぽ", kata: "ポ", romaji: ["po"] },
        ],
        [
          { hira: "ま", kata: "マ", romaji: ["ma"] },
          { hira: "み", kata: "ミ", romaji: ["mi"] },
          { hira: "む", kata: "ム", romaji: ["mu"] },
          { hira: "め", kata: "メ", romaji: ["me"] },
          { hira: "も", kata: "モ", romaji: ["mo"] },
        ],
        [
          { hira: "や", kata: "ヤ", romaji: ["ya"] },
          null,
          { hira: "ゆ", kata: "ユ", romaji: ["yu"] },
          null,
          { hira: "よ", kata: "ヨ", romaji: ["yo"] },
        ],
        [
          { hira: "ら", kata: "ラ", romaji: ["ra"] },
          { hira: "り", kata: "リ", romaji: ["ri"] },
          { hira: "る", kata: "ル", romaji: ["ru"] },
          { hira: "れ", kata: "レ", romaji: ["re"] },
          { hira: "ろ", kata: "ロ", romaji: ["ro"] },
        ],
        [
          { hira: "わ", kata: "ワ", romaji: ["wa"] },
          null,
          null,
          null,
          { hira: "を", kata: "ヲ", romaji: ["wo", "o"] }, // order by longest to shortest romaji
        ],
        [{ hira: "ん", kata: "ン", romaji: ["n"] }],
      ];

      const activeResultClasses = [
        "bg-stone-100",
        "text-stone-900",
        "dark:bg-stone-800",
        "dark:text-stone-50",
      ];

      const searchInput = document.getElementById("searchInput");
      const searchList = document.getElementById("searchList");

      searchInput.addEventListener("input", debounce(showSearchResults, 300));
      searchInput.addEventListener("keydown", (e) => {
        if (e.key !== "ArrowUp" && e.key !== "ArrowDown" && e.key != "Enter") {
          return;
        }
        e.preventDefault();
        if (lastActiveIndex == null) return;

        if (e.key === "Enter") {
          const listItem = searchList.children[lastActiveIndex];
          setPreview(listItem.id, listItem.textContent);
          searchInput.blur();
        } else if (e.key === "ArrowUp") {
          setActiveResult(
            (lastActiveIndex - 1 + searchList.childElementCount) %
              searchList.childElementCount
          );
        } else {
          setActiveResult((lastActiveIndex + 1) % searchList.childElementCount);
        }
      });

      searchInput.addEventListener("focus", () => {
        searchList.classList.remove("hidden");
        searchList.classList.add("flex");
      });
      searchInput.addEventListener("blur", () => {
        searchList.classList.add("hidden");
        searchList.classList.remove("flex");
      });

      let previewSvg = document.getElementById("previewSvg");
      const previewText = document.getElementById("previewText");
      const hiraganaBank = document.getElementById("hiraganaBank");
      const katakanaBank = document.getElementById("katakanaBank");

      function debounce(func, time) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), time);
        };
      }

      let lastActiveIndex = null;
      function setActiveResult(index) {
        if (index === lastActiveIndex) return;

        if (lastActiveIndex != null) {
          const lastItem = searchList.children[lastActiveIndex];
          lastItem.setAttribute("aria-selected", "false");
          lastItem.classList.remove(...activeResultClasses);
        }

        const listItem = searchList.children[index];
        searchList.setAttribute("aria-activedescendant", listItem.id);
        listItem.setAttribute("aria-selected", "true");
        listItem.classList.add(...activeResultClasses);

        lastActiveIndex = index;
      }

      function showSearchResults(event) {
        function getRelevantKana(input) {
          if (input.length === 0) return [];

          const testRomaji = /[a-zA-Z]+/.test(input);
          const testHira = /[ぁ-ゖ]+/.test(input);
          const testKata = /[ァ-ヶ]+/.test(input);

          const relevant = [];
          const romajiRelavant = [];

          for (const col of kana) {
            for (const info of col) {
              if (!info) continue;

              if (testHira && input.includes(info.hira)) {
                relevant.push(info);
                break;
              }
              if (testKata && input.includes(info.kata)) {
                relevant.push(info);
                break;
              }

              if (testRomaji) {
                for (const spelling of info.romaji) {
                  const match = RegExp(spelling).exec(input);
                  if (match) {
                    romajiRelavant.push([info, spelling.length, match.index]);
                    break;
                  }
                }
              }
            }
          }
          romajiRelavant.sort(([_, l1, p1], [__, l2, p2]) => {
            if (l1 === l2) return p1 - p2; // then sort by earlier position
            return l2 - l1; // sort by longest
          });
          relevant.push(...romajiRelavant.map(([info]) => info));

          return relevant;
        }

        const newChildren = [];
        getRelevantKana(event.target.value).forEach((info, index) => {
          if (index > 0) {
            const divider = document.createElement("li");
            divider.appendChild(document.createElement("hr"));
            searchList.append(divider);
          }

          const listItem = document.createElement("li");
          const charSpan = document.createElement("span");
          const infoSpan = document.createElement("span");

          infoSpan.textContent = getUnicodeName("hira", info);
          infoSpan.className = "text-stone-500 dark:text-stone-400 font-mono";

          charSpan.textContent = info["hira"];
          charSpan.className = "font-['Klee_One'] font-600 w-20";

          listItem.id = info["hira"];
          listItem.setAttribute("role", "option");
          listItem.setAttribute("aria-selected", "false");
          listItem.setAttribute("data-", "false");
          listItem.addEventListener("click", () => {
            setPreview(
              info.hira,
              `${info["hira"]} ${getUnicodeName("hira", info)}`
            );
            searchInput.blur();
          });
          listItem.addEventListener("pointerenter", () =>
            setActiveResult(index)
          );
          listItem.className =
            "h-10 px-3 flex justify-between items-center cursor-pointer dark:border-stone-800";

          listItem.append(charSpan, infoSpan);
          newChildren.push(listItem);
        });

        searchList.replaceChildren(...newChildren);

        if (newChildren.length) {
          lastActiveIndex = null;
          setActiveResult(0);
        }
      }

      function getUnicodeName(type, info) {
        return `U+${info[type].codePointAt(0).toString(16)} ${
          type === "hira" ? "HIRAGANA" : "KATAKANA"
        } ${info.romaji.at(-1)}`.toUpperCase();
      }

      const controls = document.getElementById("controls").children;
      const progressSlider = document.getElementById("progressSlider");
      progressSlider.addEventListener("input", (e) => {
        animator.setProgress(parseFloat(e.target.value));
      });

      let animator;

      controls[0].addEventListener("click", () => animator.prev());
      controls[1].addEventListener("click", () => animator.toggle());
      controls[2].addEventListener("click", () => animator.next());

      window.addEventListener("iconload", () => {
        animator = strokeAnimator(previewSvg, {
          progressCallback: (t) => (progressSlider.value = t),
        });
        progressSlider.removeAttribute("disabled");
        controls[0].removeAttribute("disabled", false);
        controls[1].removeAttribute("disabled", false);
        controls[2].removeAttribute("disabled", false);
      });

      function setPreview(char, title) {
        const fileSrc = `./dist/hiragana/${char}.svg`;
        if (fileSrc === previewSvg.getAttribute("data-src")) return;
        if (animator) animator.stop();
        progressSlider.value = 1;

        previewSvg.setAttribute("data-src", fileSrc);
        previewText.textContent = title;
      }

      function setupBanks(bank, bankEl) {
        bankEl.addEventListener("click", (e) => {
          if (!e.target.textContent || e.target.textContent.length > 1) return;
          setPreview(
            e.target.textContent,
            `${e.target.textContent} ${e.target.title}`
          );
        });

        for (const col of kana) {
          const options = document.createElement("div");
          options.className = "flex flex-col gap-1";
          for (const info of col) {
            const option = document.createElement("span");

            option.className = "border border-stone-300 rounded-md h-10 w-10";
            if (info) {
              option.textContent = info[bank];
              option.className +=
                " inline-flex justify-center items-center cursor-pointer hover:bg-stone-100 hover:text-stone-900 dark:border-stone-800 dark:hover:bg-stone-800 dark:hover:text-stone-50";

              option.title = getUnicodeName(bank, info);
            }
            options.appendChild(option);
          }
          bankEl.appendChild(options);
        }
      }

      setupBanks("hira", hiraganaBank);
      setupBanks("kata", katakanaBank);
    </script>
  </body>
</html>
